<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Methods - Alkanes Explorer</title>
  <link rel="stylesheet" href="../css/minimal.css">
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .method-card {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
    }
    .method-card h3 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }
    .method-card p {
      margin: 10px 0;
    }
    .method-link {
      display: inline-block;
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #f0f0f0;
      text-decoration: none;
      color: #000;
      border: 1px solid #ddd;
    }
    .method-link:hover {
      background-color: #e0e0e0;
    }
    .section-title {
      border-bottom: 2px solid #000;
      padding-bottom: 8px;
      margin-top: 30px;
    }
    .header-info {
      float: right;
      font-size: 14px;
    }
    .block-height-indicator {
      margin-left: 15px;
      padding: 4px 8px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    /* Category grid styling */
    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .api-status {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      background-color: #f9f9f9;
    }
    .api-status table {
      width: 100%;
      border-collapse: collapse;
    }
    .api-status th, .api-status td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .progress-bar {
      height: 20px;
      background-color: #f0f0f0;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #000;
      transition: width 0.3s ease;
    }
    .error-message {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Alkanes Explorer - API Methods</h1>
    <div class="header-info">
      <span class="block-height-indicator">Current Block: <span id="current-block-height">Loading...</span></span>
    </div>
    <nav>
      <a href="../index.html">Home</a> |
      <a href="../block-transactions.html">Block Explorer</a> |
      <a href="../transaction-search.html">Transaction Search</a> |
      <a href="../trace.html">Transaction Tracer</a>
    </nav>
  </header>

  <main class="container">
    <section class="api-status">
      <h2>API Status</h2>
      <table>
        <tr>
          <th>Metashrew Height:</th>
          <td id="metashrew-height">Loading...</td>
        </tr>
        <tr>
          <th>Bitcoin Node Height:</th>
          <td id="btc-height">Loading...</td>
        </tr>
        <tr>
          <th>Sync Progress:</th>
          <td id="sync-progress">Loading...</td>
        </tr>
      </table>
      <div class="progress-bar">
        <div class="progress-fill" id="sync-progress-bar" style="width: 0%"></div>
      </div>
    </section>

    <section id="error-messages">
      <!-- Error messages will be displayed here -->
    </section>

    <section>
      <h2>Available API Methods</h2>
      <p>
        The Alkanes Explorer provides direct access to Metashrew API methods through dedicated test pages.
        Each page allows you to experiment with individual API calls and view formatted results.
      </p>
      
      <!-- Core Alkanes Functions -->
      <h2 class="section-title">Core Alkanes Functions</h2>
      <div class="category-grid">
        <div class="method-card">
          <h3>simulate</h3>
          <p>Simulates execution of Alkanes smart contracts.</p>
          <p><strong>Input:</strong> MessageContextParcel</p>
          <p><strong>Output:</strong> SimulateResponse</p>
          <a href="simulate.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>trace</h3>
          <p>Gets detailed execution trace for a transaction.</p>
          <p><strong>Input:</strong> OutPoint (transaction ID and output index)</p>
          <p><strong>Output:</strong> Binary trace data</p>
          <a href="trace-method.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>traceblock</h3>
          <p>Gets execution traces for all transactions in a block.</p>
          <p><strong>Input:</strong> Block height</p>
          <p><strong>Output:</strong> Binary trace data for all transactions</p>
          <a href="traceblock.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>multisimulate</h3>
          <p>Simulates multiple contract executions in a single call.</p>
          <p><strong>Input:</strong> Array of MessageContextParcels</p>
          <p><strong>Output:</strong> Array of execution results</p>
          <a href="multisimulate.html" class="method-link">View Method &raquo;</a>
        </div>
      </div>
      
      <!-- Protorune Compatibility Functions -->
      <h2 class="section-title">Protorune Compatibility Functions</h2>
      <div class="category-grid">
        <div class="method-card">
          <h3>protorunesbyaddress</h3>
          <p>Gets Alkanes tokens owned by an address.</p>
          <p><strong>Input:</strong> Address (Bitcoin address)</p>
          <p><strong>Output:</strong> WalletResponse (balances and UTXOs)</p>
          <a href="protorunesbyaddress.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>protorunesbyoutpoint</h3>
          <p>Gets Alkanes tokens at a specific UTXO.</p>
          <p><strong>Input:</strong> OutPoint (transaction ID and output index)</p>
          <p><strong>Output:</strong> OutpointResponse (tokens at that UTXO)</p>
          <a href="protorunesbyoutpoint.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>protorunesbyheight</h3>
          <p>Gets Alkanes tokens created or transferred at a specific block height.</p>
          <p><strong>Input:</strong> Block height</p>
          <p><strong>Output:</strong> RunesResponse (tokens minted/transferred)</p>
          <a href="protorunesbyheight.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>spendablesbyaddress</h3>
          <p>Gets spendable outputs for an address.</p>
          <p><strong>Input:</strong> Address</p>
          <p><strong>Output:</strong> WalletResponse (spendable outputs with tokens)</p>
          <a href="spendablesbyaddress.html" class="method-link">View Method &raquo;</a>
        </div>
      </div>
      
      <!-- Legacy Runes Compatibility Functions -->
      <h2 class="section-title">Legacy Runes Compatibility Functions</h2>
      <div class="category-grid">
        <div class="method-card">
          <h3>runesbyaddress</h3>
          <p>Gets Runes tokens owned by an address (Protorunes compatibility).</p>
          <p><strong>Input:</strong> Address</p>
          <p><strong>Output:</strong> WalletResponse</p>
          <a href="runesbyaddress.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>runesbyoutpoint</h3>
          <p>Gets Runes tokens at a specific UTXO (Protorunes compatibility).</p>
          <p><strong>Input:</strong> OutPoint</p>
          <p><strong>Output:</strong> OutpointResponse</p>
          <a href="runesbyoutpoint.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>runesbyheight</h3>
          <p>Gets Runes tokens at a specific block height (Protorunes compatibility).</p>
          <p><strong>Input:</strong> Block height</p>
          <p><strong>Output:</strong> RunesResponse</p>
          <a href="runesbyheight.html" class="method-link">View Method &raquo;</a>
        </div>
      </div>
      
      <!-- JSON-RPC Methods -->
      <h2 class="section-title">JSON-RPC Methods</h2>
      <div class="category-grid">
        <div class="method-card">
          <h3>metashrew_height</h3>
          <p>Returns the current height the indexer has processed up to.</p>
          <p><strong>Input:</strong> None</p>
          <p><strong>Output:</strong> Current indexer height</p>
          <a href="metashrew-height.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>sandshrew_multicall</h3>
          <p>Allows batching multiple JSON-RPC calls in a single request.</p>
          <p><strong>Input:</strong> Array of calls</p>
          <p><strong>Output:</strong> Array of results</p>
          <a href="sandshrew-multicall.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>btc_getblockcount</h3>
          <p>Returns the current Bitcoin node's block height.</p>
          <p><strong>Input:</strong> None</p>
          <p><strong>Output:</strong> Current Bitcoin block height</p>
          <a href="btc-getblockcount.html" class="method-link">View Method &raquo;</a>
        </div>
      </div>
      
      <!-- Indexer Functions (If Applicable) -->
      <h2 class="section-title">Indexer Functions</h2>
      <p>These functions may be available depending on your Metashrew instance configuration.</p>
      <div class="category-grid">
        <div class="method-card">
          <h3>alkane_inventory</h3>
          <p>Gets token holdings for an address or token.</p>
          <p><strong>Input:</strong> AlkaneInventoryRequest</p>
          <p><strong>Output:</strong> AlkaneInventoryResponse</p>
          <a href="alkane-inventory.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>call_view</h3>
          <p>Calls a view function on an Alkanes contract.</p>
          <p><strong>Input:</strong> Alkane ID, inputs vector, fuel limit</p>
          <p><strong>Output:</strong> Raw response data</p>
          <a href="call-view.html" class="method-link">View Method &raquo;</a>
        </div>
        
        <div class="method-card">
          <h3>call_multiview</h3>
          <p>Calls multiple view functions in a single operation.</p>
          <p><strong>Input:</strong> Array of Alkane IDs, array of input vectors, fuel limit</p>
          <p><strong>Output:</strong> Combined response data</p>
          <a href="call-multiview.html" class="method-link">View Method &raquo;</a>
        </div>
      </div>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Function to add an error message
      function addErrorMessage(message) {
        const errorMessagesContainer = document.getElementById('error-messages');
        errorMessagesContainer.innerHTML = ''; // Clear previous errors
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        errorMessagesContainer.appendChild(errorDiv);
      }

      // Fallback method when RPC endpoints don't work
      async function fetchHeightDataSimple() {
        try {
          // For demo display when API might not be available
          document.getElementById('metashrew-height').textContent = '881234 (Demo)';
          document.getElementById('btc-height').textContent = '881240 (Demo)';
          document.getElementById('current-block-height').textContent = '881234 (Demo)';
          
          // Calculate sync progress
          const indexerHeight = 881234;
          const nodeHeight = 881240;
          const syncPercentage = ((indexerHeight / nodeHeight) * 100).toFixed(2);
          document.getElementById('sync-progress').textContent = syncPercentage + '% (Demo)';
          document.getElementById('sync-progress-bar').style.width = syncPercentage + '%';
          
          // Try to fetch real data
          const response = await fetch('/api/block/latest');
          if (response.ok) {
            const data = await response.json();
            if (data && data.height) {
              document.getElementById('current-block-height').textContent = data.height;
              document.getElementById('metashrew-height').textContent = data.height;
            }
          }
          
          // Try sync-status endpoint as backup
          const syncResponse = await fetch('/api/sync-status');
          if (syncResponse.ok) {
            const syncData = await syncResponse.json();
            if (syncData) {
              if (syncData.currentHeight) {
                document.getElementById('metashrew-height').textContent = syncData.currentHeight;
                document.getElementById('current-block-height').textContent = syncData.currentHeight;
              }
              if (syncData.nodeHeight) {
                document.getElementById('btc-height').textContent = syncData.nodeHeight;
                
                const realSyncPercentage = ((syncData.currentHeight / syncData.nodeHeight) * 100).toFixed(2);
                document.getElementById('sync-progress').textContent = realSyncPercentage + '%';
                document.getElementById('sync-progress-bar').style.width = realSyncPercentage + '%';
              }
            }
          }
        } catch (error) {
          console.error('Error in simplified fetch:', error);
          // Don't update the demo values if there's an error
        }
      }

      // Try to fetch sync status using sandshrew_multicall
      async function fetchSyncStatus() {
        try {
          const rpcEndpoints = ['/api/rpc', '/rpc'];
          let success = false;
          
          for (const endpoint of rpcEndpoints) {
            if (success) break;
            
            try {
              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  jsonrpc: '2.0',
                  method: 'sandshrew_multicall',
                  params: [
                    [
                      ['metashrew_height', []],
                      ['btc_getblockcount', []]
                    ]
                  ],
                  id: 1
                }),
              });
              
              if (response.ok) {
                const data = await response.json();
                
                if (data.result && Array.isArray(data.result) && data.result.length >= 2) {
                  const indexerHeight = data.result[0];
                  const nodeHeight = data.result[1];
                  
                  // Update display
                  document.getElementById('metashrew-height').textContent = indexerHeight;
                  document.getElementById('btc-height').textContent = nodeHeight;
                  document.getElementById('current-block-height').textContent = indexerHeight;
                  
                  // Calculate sync progress (ensure we don't divide by zero)
                  if (nodeHeight > 0) {
                    const syncPercentage = ((indexerHeight / nodeHeight) * 100).toFixed(2);
                    document.getElementById('sync-progress').textContent = syncPercentage + '%';
                    document.getElementById('sync-progress-bar').style.width = syncPercentage + '%';
                  } else {
                    document.getElementById('sync-progress').textContent = '0%';
                  }
                  
                  success = true;
                  console.log(`RPC call succeeded on endpoint: ${endpoint}`);
                }
              }
            } catch (e) {
              console.log(`RPC call failed on endpoint: ${endpoint}`, e);
            }
          }
          
          if (!success) {
            // Fall back to simpler method if RPC calls fail
            console.log('Falling back to simple data fetch');
            await fetchHeightDataSimple();
          }
        } catch (error) {
          console.error('Error fetching sync status:', error);
          // Fall back to simpler method
          await fetchHeightDataSimple();
        }
      }
      
      // Fetch data on page load
      fetchSyncStatus();
    });
  </script>
</body>
</html>
