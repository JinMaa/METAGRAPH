<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>runesbyaddress | Alkanes Explorer</title>
  <link rel="stylesheet" href="../css/minimal.css">
  <link rel="stylesheet" href="../css/api-methods.css">
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <h2>API Methods</h2>
    
    <!-- Core Alkanes Functions -->
    <h3>Core Alkanes Functions</h3>
    <ul>
      <li><a href="simulate.html">simulate</a></li>
      <li><a href="trace-method.html">trace</a></li>
      <li><a href="traceblock.html">traceblock</a></li>
      <li><a href="multisimulate.html">multisimulate</a></li>
    </ul>
    
    <!-- Protorune Functions -->
    <h3>Protorune Functions</h3>
    <ul>
      <li><a href="protorunesbyaddress.html">protorunesbyaddress</a></li>
      <li><a href="protorunesbyoutpoint.html">protorunesbyoutpoint</a></li>
      <li><a href="protorunesbyheight.html">protorunesbyheight</a></li>
      <li><a href="spendablesbyaddress.html">spendablesbyaddress</a></li>
    </ul>
    
    <!-- Runes Compatibility -->
    <h3>Runes Compatibility</h3>
    <ul>
      <li><a href="runesbyaddress.html">runesbyaddress</a></li>
      <li><a href="runesbyoutpoint.html">runesbyoutpoint</a></li>
      <li><a href="runesbyheight.html">runesbyheight</a></li>
    </ul>
    
    <!-- JSON-RPC Methods -->
    <h3>JSON-RPC Methods</h3>
    <ul>
      <li><a href="metashrew-height.html">metashrew_height</a></li>
      <li><a href="sandshrew-multicall.html">sandshrew_multicall</a></li>
      <li><a href="btc-getblockcount.html">btc_getblockcount</a></li>
    </ul>
    
    <!-- Indexer Functions -->
    <h3>Indexer Functions</h3>
    <ul>
      <li><a href="alkane-inventory.html">alkane_inventory</a></li>
      <li><a href="call-view.html">call_view</a></li>
      <li><a href="call-multiview.html">call_multiview</a></li>
    </ul>
    
    <div class="sidebar-footer">
      <a href="../index.html">← Back to Homepage</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Method Header -->
    <div class="method-header">
      <div class="method-title">
        <h1>runesbyaddress</h1>
        <span class="method-badge badge-runes">View Function</span>
      </div>
      <p class="method-description">Gets standard Runes tokens owned by a specific Bitcoin address. This method provides Runes compatibility alongside Alkanes' native protorunes functionality.</p>
    </div>
    
    <!-- Method Metadata -->
    <div class="method-metadata">
      <div class="metadata-item">
        <div class="metadata-label">Method Type:</div>
        <div class="metadata-value">Runes Compatibility View Function</div>
      </div>
      <div class="metadata-item">
        <div class="metadata-label">JSON-RPC Method:</div>
        <div class="metadata-value">metashrew_view</div>
      </div>
      <div class="metadata-item">
        <div class="metadata-label">View Function:</div>
        <div class="metadata-value">runesbyaddress</div>
      </div>
      <div class="metadata-item">
        <div class="metadata-label">Required Parameters:</div>
        <div class="metadata-value">address, blockTag (optional)</div>
      </div>
    </div>
    
    <!-- Examples Section -->
    <div class="example-container">
      <h2>Examples</h2>
      
      <div class="example-tabs">
        <div class="example-tab active" data-target="request-example">Request</div>
        <div class="example-tab" data-target="response-example">Response</div>
        <div class="example-tab" data-target="curl-example">cURL</div>
      </div>
      
      <div id="request-example" class="example-content">
        <h3>Example Request</h3>
        <div class="code-block">{
  "method": "metashrew_view",
  "params": [
    "runesbyaddress",
    "0x" + Buffer.from("bc1p8l8wv977433p3yg04cq7jn4hxsysqs9s3fc8xxu0s4chl0zsvaqqnhkwhv").toString("hex"),
    "latest"
  ],
  "id": 0,
  "jsonrpc": "2.0"
}</div>
      </div>
      
      <div id="response-example" class="example-content" style="display: none;">
        <h3>Example Response</h3>
        <div class="code-block">{
  "jsonrpc": "2.0",
  "result": {
    "address": "bc1p8l8wv977433p3yg04cq7jn4hxsysqs9s3fc8xxu0s4chl0zsvaqqnhkwhv",
    "balances": {
      "RUNE•EXAMPLE": "1000",
      "RUNE•TOKEN": "500"
    },
    "utxos": [
      {
        "txid": "123abc456def789ghi012jkl345mno678pqr901stu234vwx567yz8901234",
        "vout": 0,
        "runes": {
          "RUNE•EXAMPLE": "1000"
        }
      },
      {
        "txid": "987zyx654wvu321tsr098qpo765nml432kji901hgf678edc345bca123456",
        "vout": 1,
        "runes": {
          "RUNE•TOKEN": "500"
        }
      }
    ]
  },
  "id": 0
}</div>
      </div>
      
      <div id="curl-example" class="example-content" style="display: none;">
        <h3>cURL Command</h3>
        <div class="code-block">curl -vvv https://mainnet.sandshrew.io/v2/lasereyes -X POST -d '{"method":"metashrew_view","params":["runesbyaddress","0x6263317038673074386c3877763937373433337033796730346371376a6e34687873797371733973336663387878753073346368763073676338796e686b7768760a","latest"],"id":0,"jsonrpc":"2.0"}' -H 'Content-Type: application/json'</div>
      </div>
    </div>
    
    <!-- Usage Section -->
    <div class="usage-section">
      <h2>Try It</h2>
      
      <form class="usage-form api-test-form">
        <div class="form-group">
          <label for="method-name">Method:</label>
          <input type="text" id="method-name" value="metashrew_view" readonly>
        </div>
        
        <div class="form-group">
          <label for="address-input">Bitcoin Address:</label>
          <input type="text" id="address-input" placeholder="Enter a Bitcoin address (e.g., bc1p...)" value="">
        </div>
        
        <div class="form-group">
          <label for="block-tag-input">Block Tag (optional):</label>
          <input type="text" id="block-tag-input" placeholder="e.g., latest, 0x00D76FE0" value="latest">
        </div>
        
        <div class="form-group">
          <label for="method-params">Parameters (JSON array - auto-generated):</label>
          <textarea id="method-params" readonly>[
  "runesbyaddress",
  "",
  "latest"
]</textarea>
        </div>
        
        <button type="submit">Execute Request</button>
      </form>
      
      <div class="results-container">
        <p>Results will appear here after execution.</p>
      </div>
    </div>
    
    <!-- Notes Section -->
    <div class="notes-section">
      <h2>Notes</h2>
      <ul>
        <li><strong>Complex Encoding Required:</strong> The address parameter must be encoded as a Protocol Buffer message (WalletRequest), including both the address and protocol tag.</li>
        <li><strong>Endianness Considerations:</strong> Bitcoin data sometimes requires specific endianness (byte order) handling. If you're not seeing expected results, try reversing byte order in the input.</li>
        <li><strong>Block Tag Testing:</strong> If tokens were created in specific blocks, try querying with those block heights instead of "latest". For example, use "0x0D72F800" (decimal: 887000) to check a specific block.</li>
        <li><strong>Address Formatting:</strong> Ensure you're using the correct address format. Some implementations may require P2PKH format instead of bech32/taproot addresses.</li>
        <li><strong>Alternative Methods:</strong> If you can't get this endpoint to work, try using <code>runesbyheight</code> to discover tokens at specific blocks, then trace ownership from there.</li>
        <li><strong>Empty Results:</strong> Empty results (e.g., <code>{"id":0,"result":"0x","jsonrpc":"2.0"}</code>) indicate the request format was valid but no data was found for the address.</li>
        <li><strong>API Request Format:</strong> Maintain the correct field order in requests: <code>method</code>, <code>params</code>, <code>id</code>, <code>jsonrpc</code>.</li>
      </ul>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../js/api-methods.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Update parameter textarea when address input changes
      document.getElementById('address-input').addEventListener('input', function() {
        updateParamsTextarea();
      });
      
      // Update parameter textarea when block tag input changes
      document.getElementById('block-tag-input').addEventListener('input', function() {
        updateParamsTextarea();
      });
      
      // Function to update the parameters textarea
      function updateParamsTextarea() {
        const address = document.getElementById('address-input').value.trim();
        const blockTag = document.getElementById('block-tag-input').value.trim() || 'latest';
        
        const params = [
          "runesbyaddress",
          address,
          blockTag
        ];
        
        document.getElementById('method-params').value = JSON.stringify(params, null, 2);
      }
      
      // Handle form submission
      document.querySelector('.api-test-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const resultsContainer = document.querySelector('.results-container');
        resultsContainer.innerHTML = '<p>Processing request...</p>';
        
        try {
          // Get the address and block tag
          const address = document.getElementById('address-input').value.trim();
          const blockTag = document.getElementById('block-tag-input').value.trim() || 'latest';
          
          // Validate address
          if (!address) {
            throw new Error('Bitcoin address is required');
          }
          
          // Make API request
          const response = await fetch('/api/rpc', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              method: 'metashrew_view',
              params: ['runesbyaddress', address, blockTag],
              id: 0,
              jsonrpc: '2.0'
            })
          });
          
          // Check if response is okay first
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`API request failed with status ${response.status}: ${errorText}`);
          }
          
          // Try to parse the response as JSON
          let data;
          try {
            data = await response.json();
          } catch (parseError) {
            // Handle non-JSON responses
            const responseText = await response.text();
            throw new Error(`Invalid JSON response from API`, { cause: { responseText } });
          }
          
          if (data.error) {
            throw new Error(data.error.message || 'API request failed');
          }
          
          // Display results
          resultsContainer.innerHTML = `
            <div class="result-header">
              <h3><span class="status-indicator status-success"></span> Result</h3>
            </div>
            <div class="code-block">${JSON.stringify(data.result, null, 2)}</div>
            
            <details class="raw-response">
              <summary>Raw Response</summary>
              <div class="details-content">
                <div class="code-block">${JSON.stringify(data, null, 2)}</div>
              </div>
            </details>
          `;
          
        } catch (error) {
          // Display error
          let errorDetails = '';
          if (error.cause && error.cause.responseText) {
            errorDetails = error.cause.responseText;
          }
          
          resultsContainer.innerHTML = `
            <div class="result-header">
              <h3><span class="status-indicator status-error"></span> Error</h3>
            </div>
            <div class="error-message">${error.message}</div>
            
            <details class="raw-response">
              <summary>Raw Error Response</summary>
              <div class="details-content">
                <div class="code-block">${errorDetails || 'No additional error details available'}</div>
              </div>
            </details>
            
            <div class="error-tips">
              <p>Troubleshooting tips:</p>
              <ul>
                <li>Verify the address format is correct (preferably a taproot address starting with bc1p...)</li>
                <li>Check that the address exists on the blockchain</li>
                <li>The API may be experiencing issues - try again later</li>
                <li>If using a block tag other than "latest", ensure it's a valid block height</li>
              </ul>
            </div>
          `;
        }
      });
    });
  </script>
</body>
</html>
