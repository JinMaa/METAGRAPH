<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metashrew API Directory - Alkanes Explorer</title>
  <link rel="stylesheet" href="css/minimal.css">
  <link rel="stylesheet" href="css/method-explorer.css">
  <style>
    .header-section {
      margin-bottom: 30px;
    }
    .info-panel {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .endpoint-toggle {
      margin-bottom: 20px;
    }
    .code-example {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      overflow-x: auto;
      margin: 15px 0;
    }
    .note {
      padding: 10px 15px;
      background-color: #e1f5fe;
      border-left: 4px solid #03a9f4;
      margin: 15px 0;
    }
    .warning {
      padding: 10px 15px;
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
      margin: 15px 0;
    }
    .method-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .method-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      background-color: white;
    }
    .method-name {
      font-family: monospace;
      font-weight: bold;
      margin-top: 0;
    }
    .method-card p {
      margin-bottom: 10px;
    }
    .try-button {
      display: inline-block;
      background-color: #0277bd;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    .try-button:hover {
      background-color: #01579b;
    }
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-left: 10px;
    }
    .badge-common {
      background-color: #4caf50;
      color: white;
    }
    .badge-production-only {
      background-color: #ff9800;
      color: white;
    }
    .badge-local-only {
      background-color: #2196f3;
      color: white;
    }
    .nav-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .nav-tab {
      padding: 10px 15px;
      cursor: pointer;
      margin-right: 5px;
      border: 1px solid transparent;
    }
    .nav-tab.active {
      border: 1px solid #ddd;
      border-bottom-color: white;
      border-radius: 4px 4px 0 0;
      margin-bottom: -1px;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-section">
      <h1>Metashrew API Directory</h1>
      
      <div class="info-panel">
        <p><strong>Current Block Height:</strong> <span id="current-height">Loading...</span></p>
        <p><strong>Endpoint:</strong> <span id="current-endpoint">Loading...</span></p>
      </div>
      
      <div id="endpoint-toggle-container" class="endpoint-toggle"></div>
      
      <nav>
        <a href="index.html">Home</a> |
        <a href="block-transactions.html">Block Explorer</a> |
        <a href="transaction-search.html">Transaction Search</a> |
        <a href="trace.html">Transaction Tracer</a> |
        <a href="api-directory.html" class="active">API Directory</a>
      </nav>
    </div>
    
    <div class="nav-tabs">
      <div id="tab-directory" class="nav-tab active">Method Directory</div>
      <div id="tab-explorer" class="nav-tab">Interactive Explorer</div>
      <div id="tab-docs" class="nav-tab">Documentation</div>
    </div>
    
    <div id="content-directory" class="tab-content active">
      <div class="section-intro">
        <h2>Available API Methods</h2>
        <p>This directory lists all available methods in the Metashrew API. Methods are categorized by their functionality and availability across endpoints.</p>
        
        <div class="note">
          <strong>Note:</strong> Some methods are only available on specific endpoints. Look for the status badges:
          <span class="status-badge badge-common">Common</span> - Available on both local and production endpoints
          <span class="status-badge badge-production-only">Production Only</span> - Only available on the production endpoint
          <span class="status-badge badge-local-only">Local Only</span> - Only available on your local Metashrew instance
        </div>
      </div>
      
      <h3>Core Methods</h3>
      <div id="core-methods" class="method-grid">
        <!-- Core methods will be populated here -->
        <div class="loading">Loading methods...</div>
      </div>
      
      <h3>Bitcoin Methods</h3>
      <div id="bitcoin-methods" class="method-grid">
        <!-- Bitcoin methods will be populated here -->
        <div class="loading">Loading methods...</div>
      </div>
      
      <h3>Alkanes Methods</h3>
      <div id="alkanes-methods" class="method-grid">
        <!-- Alkanes methods will be populated here -->
        <div class="loading">Loading methods...</div>
      </div>
      
      <h3>Utility Methods</h3>
      <div id="utility-methods" class="method-grid">
        <!-- Utility methods will be populated here -->
        <div class="loading">Loading methods...</div>
      </div>
    </div>
    
    <div id="content-explorer" class="tab-content">
      <h2>Interactive API Explorer</h2>
      <p>Use the explorer below to browse all available methods and test them against the current endpoint.</p>
      
      <div id="method-explorer-container"></div>
    </div>
    
    <div id="content-docs" class="tab-content">
      <h2>API Documentation</h2>
      
      <h3>JSON-RPC Request Format</h3>
      <p>The Metashrew API requires a specific JSON-RPC request format that must be followed exactly:</p>
      
      <div class="code-example">
<pre>{
  "method": "method_name",
  "params": [],  // Array of parameters
  "id": 0,       // Use fixed IDs instead of timestamps
  "jsonrpc": "2.0"
}</pre>
      </div>
      
      <h4>Key Requirements</h4>
      <ul>
        <li><strong>Field Order Matters:</strong> Always arrange fields in this exact order: <code>method</code>, <code>params</code>, <code>id</code>, <code>jsonrpc</code></li>
        <li><strong>Fixed Request IDs:</strong> Use simple numerical IDs (0, 1, etc.) instead of timestamps</li>
        <li><strong>Headers:</strong> Only include <code>Content-Type: application/json</code> - no other headers needed</li>
      </ul>
      
      <div class="warning">
        <strong>Important:</strong> Do NOT include the <code>X-Sandshrew-Project-ID</code> header in any API requests. Testing has shown that the API works better without this header.
      </div>
      
      <h3>Implementation Examples</h3>
      
      <h4>JavaScript Fetch</h4>
      <div class="code-example">
<pre>async function callMetashrewApi(method, params = []) {
  const response = await fetch('https://mainnet.sandshrew.io/v2/lasereyes', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      method,
      params,
      id: 0,
      jsonrpc: '2.0'
    })
  });
  
  const data = await response.json();
  if (data.error) {
    throw new Error(`API Error: ${data.error.message}`);
  }
  
  return data.result;
}</pre>
      </div>
      
      <h4>curl Command</h4>
      <div class="code-example">
<pre>curl https://mainnet.sandshrew.io/v2/lasereyes -X POST \
  -d '{"method":"metashrew_height","params":[],"id":0,"jsonrpc":"2.0"}' \
  -H 'Content-Type: application/json'</pre>
      </div>
      
      <h3>Common Methods</h3>
      
      <h4>metashrew_height</h4>
      <p>Get current indexer height</p>
      <div class="code-example">
<pre>// Request
{
  "method": "metashrew_height",
  "params": [],
  "id": 0,
  "jsonrpc": "2.0"
}

// Response
{
  "id": 0,
  "result": "881855",
  "jsonrpc": "2.0"
}

// Note: Remember to parse the result to an integer
const height = parseInt(response.result, 10);</pre>
      </div>
      
      <h4>metashrew_view</h4>
      <p>Call a view function on the Metashrew indexer</p>
      <div class="code-example">
<pre>// Request
{
  "method": "metashrew_view",
  "params": ["alkane_inventory", "0100000000000000...", "latest"],
  "id": 0,
  "jsonrpc": "2.0"
}

// Response
{
  "id": 0,
  "result": "0x...",
  "jsonrpc": "2.0"
}</pre>
      </div>
      
      <h4>sandshrew_multicall</h4>
      <p>Batch multiple calls in a single request</p>
      <div class="code-example">
<pre>// Request
{
  "method": "sandshrew_multicall",
  "params": [
    [
      ["metashrew_height", []],
      ["btc_getblockcount", []]
    ]
  ],
  "id": 0,
  "jsonrpc": "2.0"
}

// Response
{
  "id": 0,
  "result": ["881855", 881854],
  "jsonrpc": "2.0"
}</pre>
      </div>
    </div>
  </div>
  
  <script src="js/api-config.js"></script>
  <script src="js/api-client.js"></script>
  <script src="js/alkanes-rpc.js"></script>
  <script src="js/endpoint-toggle.js"></script>
  <script src="js/method-discovery.js"></script>
  <script src="js/method-explorer.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the method explorer
      const explorer = new MethodExplorer('method-explorer-container', {
        showCategories: true,
        endpointTypeFilter: API_CONFIG.getActiveEndpointType()
      });
      
      // Fetch and display current block height
      async function fetchEndpointStatus() {
        try {
          const apiClient = new MetashrewApiClient();
          const heightStr = await apiClient.call('metashrew_height', []);
          const height = parseInt(heightStr, 10);
          
          document.getElementById('current-height').textContent = height.toLocaleString();
          document.getElementById('current-endpoint').textContent = API_CONFIG.getActiveEndpointType();
          
          console.log('[API Directory] Current height:', height);
        } catch (error) {
          console.error('[API Directory] Error fetching height:', error);
          document.getElementById('current-height').textContent = 'Error';
        }
      }
      
      // Listen for endpoint changes
      document.addEventListener('endpoint-changed', (event) => {
        console.log('[API Directory] Endpoint changed:', event.detail);
        document.getElementById('current-endpoint').textContent = event.detail.type;
        explorer.options.endpointTypeFilter = event.detail.type;
        explorer.updateMethodsList();
        fetchEndpointStatus();
        updateMethodDirectory();
      });
      
      // Update the method directory
      function updateMethodDirectory() {
        // Clear existing methods
        document.getElementById('core-methods').innerHTML = '<div class="loading">Loading methods...</div>';
        document.getElementById('bitcoin-methods').innerHTML = '<div class="loading">Loading methods...</div>';
        document.getElementById('alkanes-methods').innerHTML = '<div class="loading">Loading methods...</div>';
        document.getElementById('utility-methods').innerHTML = '<div class="loading">Loading methods...</div>';
        
        // Wait for methods to be detected
        setTimeout(() => {
          // Get methods by category
          const categories = ['core', 'bitcoin', 'alkanes', 'utility'];
          const endpointType = API_CONFIG.getActiveEndpointType();
          
          // Get available methods for local and production
          const localMethods = methodDiscovery.getAvailableMethods('LOCAL');
          const productionMethods = methodDiscovery.getAvailableMethods('PRODUCTION');
          const commonMethods = methodDiscovery.getAvailableMethods('COMMON');
          
          categories.forEach(category => {
            // Get methods for this category that are available on the current endpoint
            const methods = methodDiscovery.getMethodsByCategory(category, endpointType);
            
            if (methods.length === 0) {
              document.getElementById(`${category}-methods`).innerHTML = '<p class="no-methods">No methods available in this category</p>';
              return;
            }
            
            let html = '';
            methods.forEach(method => {
              // Determine availability badge
              let badgeClass = '';
              let badgeText = '';
              
              if (commonMethods.includes(method)) {
                badgeClass = 'badge-common';
                badgeText = 'Common';
              } else if (productionMethods.includes(method) && !localMethods.includes(method)) {
                badgeClass = 'badge-production-only';
                badgeText = 'Production Only';
              } else if (localMethods.includes(method) && !productionMethods.includes(method)) {
                badgeClass = 'badge-local-only';
                badgeText = 'Local Only';
              }
              
              const doc = methodDiscovery.getMethodDocs(method);
              
              html += `
                <div class="method-card" data-method="${method}">
                  <h4 class="method-name">${method} <span class="status-badge ${badgeClass}">${badgeText}</span></h4>
                  <p>${doc.description}</p>
                  <a href="#" class="try-button" data-method="${method}">Try it &rarr;</a>
                </div>
              `;
            });
            
            document.getElementById(`${category}-methods`).innerHTML = html;
          });
          
          // Add event listeners to "Try it" buttons
          document.querySelectorAll('.try-button').forEach(button => {
            button.addEventListener('click', (e) => {
              e.preventDefault();
              const method = e.target.dataset.method;
              
              // Switch to explorer tab
              switchTab('explorer');
              
              // Find and click the method in the explorer
              setTimeout(() => {
                const methodItem = document.querySelector(`.method-item[data-method="${method}"]`);
                if (methodItem) {
                  methodItem.click();
                  methodItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
              }, 100);
            });
          });
        }, 1000); // Give time for method detection to complete
      }
      
      // Tab switching
      const tabs = ['directory', 'explorer', 'docs'];
      
      function switchTab(tabId) {
        // Hide all content
        tabs.forEach(tab => {
          document.getElementById(`content-${tab}`).classList.remove('active');
          document.getElementById(`tab-${tab}`).classList.remove('active');
        });
        
        // Show selected content
        document.getElementById(`content-${tabId}`).classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
      }
      
      // Add click event listeners to tabs
      tabs.forEach(tab => {
        document.getElementById(`tab-${tab}`).addEventListener('click', () => {
          switchTab(tab);
        });
      });
      
      // Initial fetch of endpoint status
      fetchEndpointStatus();
      
      // Initial update of method directory
      updateMethodDirectory();
    });
  </script>
</body>
</html>
